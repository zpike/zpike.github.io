<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>使用 Travis-CI 来自动化部署 Hexo · SPIKE</title><meta name="description" content="使用 Travis-CI 来自动化部署 Hexo - Spike Joe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="http://spikezz.com/atom.xml" title="SPIKE"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.ico" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/zpike" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://twitter.com/zshe404" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 Travis-CI 来自动化部署 Hexo</h1><div class="tags"><a href="/tags/hexo-travis/" class="tag-title">#hexo travis</a></div><div class="post-info">Feb 20, 2017</div><div class="post-content"><p><img src="http://oc1hnrd8p.bkt.clouddn.com/photos/20170227/111351727.jpg" alt="mark"></p>
<p>之前写过一个 <a href="http://spikezz.com/2016/07/07/how-to-create-a-hexo-blog" target="_blank" rel="external">Hexo 博客的搭建方法</a>，搭建好之后我就没有怎么写博客了。一来是因为自己没什么好分享的（其实就是懒哈），二来是感觉静态技术博客这种形式已经落伍了，如果要学某种技术，还是直接找视频教程比较快。</p>
<p>不过因为知道了“持续集成”，即 <code>Continuous integration</code>，这种技术已经很常见了，不过我最近才学习到。用在 hexo 博客的部署上比较合适，整个部署也比较简单，适合我这种小白。</p>
<a id="more"></a>
<p>之前部署 hexo 博客，只要在终端输入 <code>hexo g -d</code>即可，当然前提是你已经写好文章了呀，写不出文章的话我是帮不了的。而且已经搭建好博客环境，即 node.js 相关及 Hexo 本身。那换成 <code>Travis CI</code> 的持续集成服务到底有什么用呢？操作会不会更简单？答案是—–不会！</p>
<p>那TM要它有什么用？！</p>
<p>且听我慢慢说。</p>
<h1 id="什么叫持续集成"><a href="#什么叫持续集成" class="headerlink" title="什么叫持续集成"></a>什么叫持续集成</h1><p>网上很多解释，感兴趣的可以看看阮一峰的<a href="http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html" target="_blank" rel="external">这篇文章</a>。</p>
<p>概括起来讲，就是一个外包公司，博主只管写好文章，然后丢给它去处理，它就自动给你各种加工渲染，然后放到博客页面上去。你只需在有网络的地方即可开始写作，当然也要能无障碍访问 GitHub 才行啊（关于如何更快访问墙外网络，我会在之后一篇文章说明）。直接登录 GitHub 账号写东西，实在不够优雅，所以还要弄个 Markdown 编辑器，本地或者基于 Web 的都可以（Mac 推荐用 <code>Bear</code>，web的就用 <code>Cmd Markdown</code>），写完直接 push 到 GitHub 即可，其他各种库、主题什么的更新都不用管了。这才是新时代的方法—-只要提出需求，然后交给“云”处理。</p>
<h1 id="Travis-CI-介绍"><a href="#Travis-CI-介绍" class="headerlink" title="Travis-CI 介绍"></a>Travis-CI 介绍</h1><p><code>Travis CI</code> 是目前新兴的开源持续集成构建项目，用来构建托管在GitHub上的代码。简单来说，<code>Travis CI</code>原理就是当你每次提交 <code>commit</code> 到在 <code>GitHub</code> 后，它会自动检测你的提交，同时根据的配置文件，生成一个 Linux 虚拟机来运行你的命令，通常这些命令用于测试，构建等。在我们的要求下，就可以用它运行一些<code>hexo g d</code>之类的命令来自动生成、部署我静态网页。好像不是很懂，没关系，做一遍就懂了。</p>
<p><a href="https://docs.travis-ci.com/user/getting-started" target="_blank" rel="external">Travis-CI 官方文档</a>，有时间，懂英语的可以仔细看看。写得最好的还是官方文档，一般我们总是各种找教程什么的，其实最好的教程就是自带的文档。</p>
<h1 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h1><p>看到这里，应该都有了 <code>GitHub</code> 的 Pages了，不然也不会涉及到部署什么的。下面步骤前提是在你电脑上可以 <code>hexo g -d</code>成功的前提下进行的。</p>
<p>登陆<code>Travis CI</code>官网，使用GitHub账户登录，发现你的 <code>repos</code>都出现了吧。然后关键了。选择你要启动的项目，在这里也就是<code>yourname/yourname.GitHub.io</code>，你的博客项目地址。</p>
<p>然后点击设置按钮，进入设置选项，开启第一行的服务:</p>
<ul>
<li><code>Build only if .travis.yml is present</code>：是只有在.travis.yml文件中配置的分支改变了才构建；</li>
<li><code>Build pushes</code>：当推送完这个分支后开始构建。</li>
</ul>
<center><img src="http://static.zybuluo.com/spikett/53whszhrw6l15onttf8d20ol/Snip20170223_2.png" alt="Snip20170223_2.png-54.3kB"></center>

<p>到这一步， 我们已经开启了要构建的仓库。但此时Travis还没法帮助我们自动构建并部署，因为没有访问GitHub的权限。我们自己在本地计算机上push能成功是因为有了 SSH key，但是交给 travis去部署的话，它是没有这个key的，但是也可以给它，只要加密再解密就好了，配置文件配置可以参考文末的链接。不过我这里就用GitHub提供的token变量功能吧，比较适合新手。</p>
<p>在 <code>GitHub</code> 上为 <code>Travis CI</code> 配置 <code>Acess Token</code>，登陆GitHub，进入设置界面，点击到 <code>Personal access tokens</code> 页面。</p>
<p>点击右上角的<code>Generate new token</code> 按钮会生成新的token，点击后提示输入密码后继续，然后来到如下界面，取个名字（我这里取 <code>GH_token</code>，下面配置文件中要用到，牢记！），勾选一些权限（只要repo就行了，还有email），这个token很重要，如果别人也有了这个token，你<code>GitHub</code>账户的repo就可能被任意修改！！所以不能外泄这个token！重要的事情就不说三遍了。不过如果外泄了，登录你的GitHub，删除这个token即可。</p>
<p><img src="http://static.zybuluo.com/spikett/yp8xndh33eha7yxsdwxhcb99/Snip20170223_3.png" alt="Snip20170223_3.png-148.2kB"></p>
<p>生成完后，拷贝下来，只有这时候才会显示，下载进来为了安全他就不会显示了，如果忘了只能重新生成一个了，拷贝完以后到<code>Travis CI</code>页面中 <code>Environment Variables</code> 进行配置。</p>
<p>现在 Travis CI 已获得 GitHub 访问权限，但它并不知道如何进行部署，所以还需要进一步设置。</p>
<p>在源代码分支（我这里即 blog-source 分支）下配置 <code>.travis.yml</code> 文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="attr">language:</span> <span class="string">node_js</span>   <span class="comment">#设置语言</span></div><div class="line"><span class="attr">node_js:</span> <span class="string">stable</span>     <span class="comment">#设置相应的版本</span></div><div class="line"></div><div class="line"><span class="attr">cache:</span></div><div class="line"><span class="attr">    directories:</span></div><div class="line"><span class="bullet">        -</span> <span class="string">node_modules</span>    <span class="comment">#据说可以减少travis构建时间</span></div><div class="line"></div><div class="line"><span class="attr">before_install:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">git</span> <span class="string">clone</span> <span class="attr">https://github.com/zpike/hexo-theme-apollo.git</span> <span class="string">themes/apollo</span></div><div class="line">       <span class="comment">#自己配置一个主题，也是乐趣之一，特效什么的，不过我还是偏好简洁（Next主题用的人真是多啊）</span></div><div class="line"></div><div class="line"><span class="comment"># S: Build Lifecycle</span></div><div class="line"><span class="attr">install:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">npm</span> <span class="string">install</span>   <span class="comment">#安装hexo及插件</span></div><div class="line"></div><div class="line"><span class="attr">before_script:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">clone</span> <span class="bullet">--branch</span> <span class="string">master</span> <span class="attr">https://github.com/zpike/zpike.github.io.git</span> <span class="string">public</span></div><div class="line">        <span class="comment">#获取最新的commit信息</span></div><div class="line"></div><div class="line"><span class="attr">script:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">hexo</span> <span class="string">cl</span>   <span class="comment">#清除</span></div><div class="line"><span class="bullet">  -</span> <span class="string">hexo</span> <span class="string">g</span>   <span class="comment">#生成</span></div><div class="line"></div><div class="line"><span class="attr">after_script:</span></div><div class="line"><span class="bullet">  -</span> <span class="string">cd</span> <span class="string">./public</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">init</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">"zpike"</span>   <span class="comment">#修改成自己的github用户名</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="string">"conan401@126.com"</span>   <span class="comment">#修改成自己的GitHub邮箱</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">commit</span> <span class="bullet">-m</span> <span class="string">"update"</span></div><div class="line"><span class="bullet">  -</span> <span class="string">git</span> <span class="string">push</span> <span class="bullet">--force</span> <span class="bullet">--quiet</span> <span class="string">"https://$&#123;GH_token&#125;@$&#123;GH_REF&#125;"</span> <span class="attr">master:master</span> <span class="comment">#GH_token就是在travis中设置的token</span></div><div class="line"></div><div class="line"><span class="attr">branches:</span></div><div class="line"><span class="attr">  only:</span></div><div class="line"><span class="bullet">    -</span> <span class="string">blog-source</span>  <span class="comment">#只监测这个分支，一有动静就开始构建（我可能发一篇文章会push好多次，每次看到它忙着构建，感觉好浪费）。</span></div><div class="line"><span class="attr">env:</span></div><div class="line"><span class="attr">    global:</span></div><div class="line"><span class="attr">        - GH_REF:</span> <span class="string">github.com/zpike/zpike.github.io.git</span></div></pre></td></tr></table></figure>
<p>大致结构就是这样，根据自己的需求还需要一点修改。</p>
<p><code>.travis.yml</code> 配置完成，这个时候就可以push文章到你的 <code>blog-source</code> 分支上去了。然后其他工作都由 Travis-CI 来完成。</p>
<p>登陆<code>Travis CI</code>，不出意外的话（我出了好多次意外，不过最终皇天不负有心人！哈哈）Travis已经检测到变化并进行构建部署，log记录了构建的过程，出什么问题里面都可以点开来看。</p>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>如果出问题，基本都是配置文件的问题，yml文件的格式还是要求比较严格的，稍微不注意就不行。.travis.yml 文件的主要流程分三步，获取历史，生产静态文件，发布。</p>
<ul>
<li><p><code>before_script</code>: 在所有动作之前，先把 master 分支clone到<code>./public</code>文件夹，保留之前的 commit记录，把最新结果提交上去。</p>
</li>
<li><p><code>script</code>: 就是 <code>hexo generate</code>的过程。</p>
</li>
<li><p><code>after_success</code>: 在成功之后，成功都到了public文件夹下，然后就是照着<code>git push</code>到<code>master</code>分支下。</p>
</li>
</ul>
<p>当然还需要确认<code>travis build</code>都在 <code>blog-source</code>分支下工作。</p>
<h4 id="主题设置"><a href="#主题设置" class="headerlink" title="主题设置"></a>主题设置</h4><p>网上很多hexo的主题，有的还在持续更新，这个就需要在配置文件中clone 一下，保持更新，或者在package.jason文件中配置一下也行吧（没试过），还是在travis配置文件中设置一下，方便换主题。设置在 <code>before_install</code> 后面。</p>
<h4 id="git命令"><a href="#git命令" class="headerlink" title="git命令"></a>git命令</h4><p>这套方案弄完之后，在任何电脑，只要有git，就可以写东西了。git指令如何操作呢？</p>
<p>新手可能会比较麻烦。比如我。虽然我很早就用过git，不过很多指令学了忘，忘了学。其实最好的学习就是不断使用，如果几周不用，再好的工具也记不住。比如vim或者emacs。</p>
<p>git新手建议看看<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="external">廖雪峰的博客</a>，还有<a href="https://git-scm.com/book/en/v2" target="_blank" rel="external"><strong>git-scm</strong></a>，还有<a href="https://www.git-tower.com/learn/git/ebook/en/desktop-gui/basics/basic-workflow#" target="_blank" rel="external"><strong>git-tower</strong>官网</a>的很多教程，写得非常好，图文并茂，入门书籍的话应该无出其右了。</p>
<p>不过在写博客这方面，只需要记住几个常用的命令就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git clone git@github.com:zpike/zpike.github.io.git  #先克隆</div><div class="line">git checkout origin/blog-source   #默认是master分支，然后切换分支</div><div class="line">git checkout -b blog-source   #本地新建一个博客源文件分支</div><div class="line"></div><div class="line">git add .   #写完博客添加文件</div><div class="line">git commit -m &quot;xxx&quot;  #加入commit信息</div><div class="line">git push origin blog-source  #push到远程</div></pre></td></tr></table></figure>
<p>记住以上必用的命令当然不够，为了更方便操作，还是需要多多记住一些常用的git命令。</p>
<p>如果在web上直接写文章的话，看下面。当然不建议这么做啦，不过如果身边没有设备的话，只有一只手机，那也没办法。灵感来了挡不住呀。</p>
<p><a href="http://prose.io" target="_blank" rel="external">prose</a>这个网站不错，很清爽，然后可以和<strong>Github</strong> 绑定，这样就可以直接在这上面写你的<strong>Pages</strong>博客了，写好直接save，搞定！。网页端暂时只有这个我比较满意。</p>
<p>好的客户端还在寻找中，如果<strong>Bear</strong>或者<strong>Ulysses</strong>支持就好了，或者好像<strong>Tower</strong>是管理GitHub的利器，不行也可以那里写，只是不知道markdown支持如何。</p>
<p>不过虽然可以直接写，但是很多<strong>Hexo</strong>的特性就用不到了，比如一些模版什么的，每次还要自己输入元数据，还是稍显麻烦。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>现在终于可以anywhere, anyplatform, anyeditor都可以开始写作了，还是很不错的。要做的就是打开editor，然后写完push即可，不用操心其它，多美好！</p>
<p>在工具的路径上是没有止境的，生命不息，折腾不止。</p>
<hr>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://www.jianshu.com/p/5e74046e7a0f" target="_blank" rel="external">使用 Travis CI 自动部署 Hexo</a></p>
<p><a href="https://levirve.GitHub.io/2016/hexo-deploy-through-travisci" target="_blank" rel="external">使用 Travis CI 自動發布 hexo 到 GitHub pages</a></p>
<p><a href="http://kchen.cc/2016/11/12/hexo-instructions/" target="_blank" rel="external">基于 Hexo 的全自动博客构建部署系统</a></p>
<p><a href="https://zespia.tw/blog/2015/01/21/continuous-deployment-to-github-with-travis/" target="_blank" rel="external">用 Travis CI 自動部署網站到 GitHub(Hexo 作者写的)</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/03/05/genetic-algorithm/" class="prev">PREV</a><a href="/2016/08/12/chrome-extensions-recommend/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'spikezhou';
var disqus_identifier = '2017/02/20/auto-deploy-hexo-on-travis-ci/';
var disqus_title = '使用 Travis-CI 来自动化部署 Hexo';
var disqus_url = 'http://spikezz.com/2017/02/20/auto-deploy-hexo-on-travis-ci/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//spikezhou.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2017 <a href="http://spikezz.com">Spike Joe</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>